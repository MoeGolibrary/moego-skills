#!/usr/bin/env bash
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Config
INSTALL_DIR="$HOME/.claude/plugins/moego-skills"
SKILLS_DIR="$INSTALL_DIR/skills"
VERSION="1.0.0"

# Functions
show_help() {
    echo -e "${BLUE}MoeGo Skills CLI v$VERSION${NC}"
    echo ""
    echo "Usage: moego-skills <command>"
    echo ""
    echo "Commands:"
    echo "  update    Update all skills to latest version"
    echo "  list      List installed skills"
    echo "  help      Show this help message"
    echo "  version   Show version"
    echo ""
    echo "Examples:"
    echo "  moego-skills update"
    echo "  moego-skills list"
}

do_update() {
    echo -e "${GREEN}ðŸ”„ Updating MoeGo Skills...${NC}"

    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}Error: MoeGo Skills not installed. Run install script first.${NC}"
        exit 1
    fi

    cd "$INSTALL_DIR"

    # Check for local changes
    if [ -n "$(git status --porcelain)" ]; then
        echo -e "${YELLOW}Warning: Local changes detected, stashing...${NC}"
        git stash
    fi

    old_rev=$(git rev-parse HEAD)
    git pull --ff-only
    new_rev=$(git rev-parse HEAD)

    if [ -z "${MOEGO_SKILLS_NO_REEXEC:-}" ] && [ "$old_rev" != "$new_rev" ]; then
        MOEGO_SKILLS_NO_REEXEC=1 exec "$0" update
    fi

    # Re-link skills
    CLAUDE_SKILLS_DIR="$HOME/.claude/skills"
    CODEX_SKILLS_DIR="$HOME/.codex/skills"
    OPENCODE_SKILLS_DIR="$HOME/.config/opencode/skills"
    mkdir -p "$CLAUDE_SKILLS_DIR" "$CODEX_SKILLS_DIR" "$OPENCODE_SKILLS_DIR"

    for skill_dir in "$SKILLS_DIR/"*/; do
        skill_name=$(basename "$skill_dir")
        if [ -f "$skill_dir/SKILL.md" ]; then
            skill_display_name=$(sed -n 's/^name:[[:space:]]*//p' "$skill_dir/SKILL.md" | head -n 1)
            link_name="${skill_display_name:-$skill_name}"

            rm -f "$CLAUDE_SKILLS_DIR/$skill_name.md" "$CLAUDE_SKILLS_DIR/$link_name.md"

            if [[ "$link_name" == *:* ]]; then
                legacy_name="${link_name//:/-}"
                if [ "$legacy_name" != "$link_name" ] && [ ! -d "$SKILLS_DIR/$legacy_name" ]; then
                    rm -f "$CLAUDE_SKILLS_DIR/$legacy_name" "$CODEX_SKILLS_DIR/$legacy_name" "$OPENCODE_SKILLS_DIR/$legacy_name"
                fi
            fi

            if [ "$skill_name" != "$link_name" ]; then
                rm -f "$CLAUDE_SKILLS_DIR/$skill_name" "$CODEX_SKILLS_DIR/$skill_name" "$OPENCODE_SKILLS_DIR/$skill_name"
            fi

            ln -sfn "${skill_dir%/}" "$CLAUDE_SKILLS_DIR/$link_name"
            ln -sfn "${skill_dir%/}" "$CODEX_SKILLS_DIR/$link_name"
            ln -sfn "${skill_dir%/}" "$OPENCODE_SKILLS_DIR/$link_name"
        fi
    done

    echo -e "${GREEN}âœ… Updated successfully!${NC}"
}

do_list() {
    echo -e "${BLUE}Installed MoeGo Skills:${NC}"
    echo ""

    if [ ! -d "$SKILLS_DIR" ]; then
        echo -e "${YELLOW}No skills installed.${NC}"
        exit 0
    fi

    for skill_dir in "$SKILLS_DIR/"*/; do
        if [ -d "$skill_dir" ]; then
            skill_name=$(basename "$skill_dir")
            if [ -f "$skill_dir/SKILL.md" ]; then
                display_name=$(sed -n 's/^name:[[:space:]]*//p' "$skill_dir/SKILL.md" | head -n 1)
                display_name="${display_name:-$skill_name}"
                # Extract description from SKILL.md (first line after "description:")
                desc=$(grep -m1 "^description:" "$skill_dir/SKILL.md" 2>/dev/null | sed 's/description: *//' || echo "No description")
                echo -e "  ${GREEN}$display_name${NC}"
                echo "    $desc"
                echo ""
            fi
        fi
    done
}

# Main
case "${1:-help}" in
    update)
        do_update
        ;;
    list)
        do_list
        ;;
    version)
        echo "moego-skills v$VERSION"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
